# Регистрация модели в Dify

## Как это работает

После установки расширения, модель **BGE Reranker v2 m3** автоматически регистрируется в Dify как доступный reranker провайдер и появляется в списке моделей.

## Процесс регистрации

### 1. Установка расширения

При установке расширения через веб-интерфейс Dify:

1. Dify загружает файл `.difypkg`
2. Извлекает все файлы расширения
3. Устанавливает зависимости из `requirements.txt`
4. Загружает класс провайдера из `main.py`

### 2. Регистрация провайдера

Dify автоматически обнаруживает провайдера через:

- **manifest.yaml** - содержит `provider_class: "main:BGERerankerProvider"`
- **main.py** - содержит класс `BGERerankerProvider`
- Класс провайдера предоставляет информацию о модели

### 3. Появление в списке моделей

После регистрации:

- Модель появляется в **Settings → Model Providers → Reranker**
- Отображается как **"BGE Reranker"** с моделью **"BAAI/bge-reranker-v2-m3"**
- Доступна для выбора в Knowledge Base и Workflow

## Где найти модель

### В интерфейсе Dify:

1. **Settings → Model Providers**
   - Найдите раздел **"Reranker"**
   - Увидите **"BGE Reranker"** в списке

2. **Knowledge Base Settings**
   - При создании/редактировании Knowledge Base
   - В разделе **"Reranker Model"**
   - Выберите **"BAAI/bge-reranker-v2-m3"**

3. **Workflow Editor**
   - При добавлении узла Reranker
   - В выпадающем списке моделей
   - Выберите **"BAAI/bge-reranker-v2-m3"**

## Настройка модели

После выбора модели необходимо настроить подключение:

### Обязательные параметры:

- **API URL** - URL вашего Reranker API сервиса
  - Пример: `http://localhost:8009`
  - Или: `https://your-domain.com:8009`

### Опциональные параметры:

- **Timeout** - таймаут запросов (по умолчанию 30 секунд)
- **Top K** - количество возвращаемых результатов (по умолчанию 5)

## Проверка регистрации

### Способ 1: Через интерфейс

1. Откройте **Settings → Model Providers**
2. Найдите раздел **"Reranker"**
3. Должна быть видна модель **"BGE Reranker"**

### Способ 2: Через API (если доступно)

```bash
# Получить список reranker провайдеров
curl http://your-dify-server/api/v1/models/providers/reranker
```

### Способ 3: Проверка логов

Проверьте логи Dify на наличие сообщений о регистрации провайдера:

```
[INFO] Registered reranker provider: BGE Reranker
[INFO] Model available: BAAI/bge-reranker-v2-m3
```

## Устранение проблем

### Модель не появляется в списке

**Причины:**
1. Расширение не установлено правильно
2. Ошибка при загрузке класса провайдера
3. Несовместимость версии Dify

**Решение:**
1. Переустановите расширение
2. Проверьте логи Dify на наличие ошибок
3. Убедитесь, что версия Dify поддерживает кастомные провайдеры
4. Проверьте, что файл `main.py` содержит класс `BGERerankerProvider`

### Модель видна, но не работает

**Причины:**
1. Неправильный API URL
2. Reranker API недоступен
3. Ошибки в конфигурации

**Решение:**
1. Проверьте доступность API: `curl http://your-api:8009/health`
2. Убедитесь, что URL правильный в настройках модели
3. Проверьте логи Dify и Reranker API на наличие ошибок

### Ошибка валидации credentials

**Причины:**
1. API URL недоступен
2. Health endpoint не отвечает

**Решение:**
1. Убедитесь, что Reranker API запущен
2. Проверьте доступность health endpoint
3. Проверьте сетевые настройки и файрвол

## Структура провайдера

Класс `BGERerankerProvider` предоставляет:

- `get_provider_info()` - информация о провайдере
- `validate_credentials()` - валидация настроек подключения
- `get_models()` - список доступных моделей

Это позволяет Dify:
- Отображать модель в интерфейсе
- Валидировать настройки перед использованием
- Предоставлять список моделей для выбора

## Дополнительная информация

- См. `README.md` для полной документации
- См. `INSTALL.md` для инструкций по установке
- См. `main.py` для кода провайдера

